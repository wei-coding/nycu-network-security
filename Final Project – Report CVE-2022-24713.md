# Final Project – Report <br>CVE-2022-24713

311551093 資科工一 游庭瑋

## Introduction

This CVE pertains to the `regex` crate in the Rust language, which provides an implementation of regular expressions. While the `regex` crate has built-in measures to prevent DOS attacks from untrusted regexes or input, a bug exists that causes a long delay in checking if a regex is untrusted. This bug can be exploited to perform a DOS attack. Versions 1.5.4 and earlier are affected by this issue.

## CVE environment

We use Rust docker image as our environment and install `regex=1.5.4` as our test `regex` crate inside the container. Below is the complete environment. 

* Ubuntu 22.04
* Docker 23.01
* Rust image, tag=`1-bullseye`
* regex 1.5.4

## Preparation to reproduce the exploitation

The vulnerability in `Rust` arises during the compilation of certain specific regular expressions. The initial step is to identify the code causing the issue. The `regex` crate's GitHub repository contains the commit history and unit tests, which can be used to replicate the vulnerability.

### Git Commit: security: fix denial-of-service bug in compiler

According to the developers on the `rust-lang/regex` GitHub page, commit `ae70b41d4f46641dbc45c7a4f87954aea356283e`, the previous implementation did not allocate any memory for empty sub-expressions during compilation, which prevented the pre-existing mechanism from being triggered. As a result, the pattern would continue to compile until it succeeded, which could take a significant amount of time.

The page also includes a list of patterns that are known to take a long time to compile, which are as follows:

* `(?:){4294967295}`
* `(?:){64}{64}{64}{64}{64}{64}`
* `x{0}{4294967295}`
* `(?:|){4294967295}`

## Code part

### Files

There is a complete rust project in the `code` folder, called `regex-cve`. the main file is `main.rs`, which contain all code to reproduce the vulnerability. In `Cargo.toml`, a specific `regex` crate version is set. You can use `cargo` to run this project.

### Explaination

To reproduce the vulnerability, I wrote some simple Rust code that uses the `regex` crate and compiles the aforementioned "special" regular expression pattern. Additionally, I used the `std::time` crate to measure the time it takes to compile that pattern.

```rust
use regex::Regex;
use std::time::Instant;

fn main() {
    let now = Instant::now();
    let s = "(?:){4294967295}";
    let re = Regex::new(s).unwrap();
    println!("Compile Finished! Compile takes {:?} seconds", now.elapsed());
    println!("match result: {}", re.is_match(" "));
}
```

The first two lines indicate that the program will be using the `regex` and `std::time` crates. In the `main` function, a variable named `now` is created to record the start time of compilation. Next, the regular expression is compiled using the `Regex::new(s)` method. Once the pattern has been compiled, the `println!` macro is called to display the time taken for compilation, as well as to test whether `match` works properly.